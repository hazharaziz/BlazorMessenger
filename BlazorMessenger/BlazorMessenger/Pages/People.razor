@page "/people"
@inject ISearchable<User> SearchAPI
@inject IFollowerAPI FollowerAPI
@inject Blazored.SessionStorage.ISessionStorageService SessionStorage


<h3>Search People</h3>
<EditForm Model="@searchQuery" OnValidSubmit="@SearchUser" class="mr-auto" style="margin: 10px;">
    <div style="display: block;">
        <input class="col-8" @bind="@searchQuery" type="text" id="search-input" placeholder="Search people" />
        <input class="col-2" type="submit" value="Submit" />
    </div>
</EditForm>

@foreach (User user in fetchedUsers)
{
    var name = $"{user.FirstName} {user.LastName}";
<div class="row" id="user-@user.Id" style="padding: 10px; border-bottom: 1px black solid;">
    <a href="/profile/@user.Id" class="col-3">@name</a>
    @if (FollowerAPI.HasRequestFrom(currentUserId, user.Id))
    {
        <button class="col-1 ml-0" @onclick="(() => AcceptRequest(currentUserId, user.Id))">Accept Request</button>
        <button class="col-1 ml-0" @onclick="(() => RejectRequest(currentUserId, user.Id))">Reject Request</button>
    }
    @if (FollowerAPI.HasRequestFrom(user.Id, currentUserId))
    {
        <button class="col-1 ml-0" @onclick="(() => CancelRequest(user.Id, currentUserId))">Cancel Follow Request</button>
    }
    else if (FollowerAPI.HasFollower(user.Id, currentUserId))
    {
        <button class="col-1 ml-0" @onclick="(() => UnFollowUser(user.Id, currentUserId))">Unfollow</button>
    }
    else
    {
        <button class="col-1 ml-0" @onclick="(() => FollowUser(user.Id, currentUserId))">Follow</button>
    }
    <a href="/profile/@user.Id" class="col-1 ml-0">Profile</a>
</div>
}

@code {

    private string searchQuery;
    private int currentUserId;
    private List<User> fetchedUsers;

    protected override async Task OnInitializedAsync()
    {
        searchQuery = string.Empty;
        currentUserId = 0;
        fetchedUsers = new List<User>();
        await base.OnInitializedAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        string username = await SessionStorage.GetItemAsync<string>("username");
        currentUserId = await SessionStorage.GetItemAsync<int>("id");
        StateHasChanged();
        await base.OnAfterRenderAsync(firstRender);
    }

    private async Task<bool> SearchUser()
    {
        try
        {
            fetchedUsers = (searchQuery != "") ? SearchAPI.Search(searchQuery) : new List<User>();
            return await Task.FromResult(true);
        }
        catch
        {
            return await Task.FromResult(false);
        }
    }

    private void FollowUser(int userId, int followerId)
    {
        try
        {
            FollowerAPI.SendFollowRequest(userId, followerId);
        }
        catch { }
    }

    private void UnFollowUser(int userId, int followerId)
    {
        try
        {
            FollowerAPI.Unfollow(userId, followerId);
        }
        catch { }
    }

    private void AcceptRequest(int userId, int followerId)
    {
        try
        {
            FollowerAPI.AcceptFollowRequest(userId, followerId);
        }
        catch (Exception)
        {
        }
    }

    private void RejectRequest(int userId, int followerId)
    {
        try
        {
            FollowerAPI.RejectFollowRequest(userId, followerId);
        }
        catch (Exception)
        {
        }
    }

    private void CancelRequest(int userId, int followerId)
    {
        try
        {
            FollowerAPI.CancelRequest(userId, followerId);
        }
        catch (Exception)
        {
        }
    }
}
